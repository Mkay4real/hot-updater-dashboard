name: Sync Upstream

on:
  schedule:
    # Run every Sunday at midnight UTC
    - cron: '0 0 * * 0'
  workflow_dispatch: # Allows manual triggering from Actions tab

jobs:
  sync:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0 # Fetch all history for proper merging

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Add upstream remote
        run: |
          git remote add upstream https://github.com/your-username/hot-updater-dashboard.git || true
          git remote -v

      - name: Fetch upstream changes
        run: |
          git fetch upstream
          echo "Fetched upstream changes"

      - name: Merge upstream changes
        id: merge
        run: |
          git merge upstream/main --no-edit || echo "MERGE_CONFLICT=true" >> $GITHUB_OUTPUT
        continue-on-error: true

      - name: Check for conflicts
        if: steps.merge.outputs.MERGE_CONFLICT == 'true'
        run: |
          echo "⚠️ Merge conflicts detected. Manual intervention required."
          echo "Please resolve conflicts manually by following these steps:"
          echo "1. Clone your repository locally"
          echo "2. Run: git remote add upstream https://github.com/your-username/hot-updater-dashboard.git"
          echo "3. Run: git fetch upstream"
          echo "4. Run: git merge upstream/main"
          echo "5. Resolve conflicts in your editor"
          echo "6. Run: git add . && git commit && git push"
          exit 1

      - name: Push changes
        if: steps.merge.outputs.MERGE_CONFLICT != 'true'
        run: |
          git push origin main
          echo "✅ Successfully synced with upstream repository"

      - name: Create Issue on Conflict
        if: failure() && steps.merge.outputs.MERGE_CONFLICT == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: '⚠️ Upstream Sync Failed - Merge Conflicts',
              body: `The automated upstream sync encountered merge conflicts and requires manual intervention.

              ## What happened?
              The weekly sync with the upstream repository found changes that conflict with your customizations.

              ## How to resolve:
              1. Clone your repository locally:
                 \`\`\`bash
                 git clone https://github.com/${context.repo.owner}/${context.repo.repo}.git
                 cd ${context.repo.repo}
                 \`\`\`

              2. Add upstream remote:
                 \`\`\`bash
                 git remote add upstream https://github.com/your-username/hot-updater-dashboard.git
                 git fetch upstream
                 \`\`\`

              3. Merge and resolve conflicts:
                 \`\`\`bash
                 git merge upstream/main
                 # Resolve conflicts in your editor
                 git add .
                 git commit -m "Merge upstream with conflict resolution"
                 git push origin main
                 \`\`\`

              ## Need help?
              Check the [Contributing Guide](CONTRIBUTING.md#handling-merge-conflicts) for detailed instructions.

              This issue was automatically created by the Sync Upstream workflow.
              `,
              labels: ['sync-conflict', 'automated']
            })
